<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tradebe Molino v9.2</title>
    <style>
        :root { 
            --blue: #0056b3; --green: #89b434; --orange: #e87e04; 
            --light: #f8f9fa; --dark: #2c3e50; --border: #dee2e6;
            --white: #ffffff; --shadow: rgba(0,0,0,0.08);
            --red: #dc3545;
        }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background: var(--light); margin: 0; padding: 0; color: var(--dark); }
        
        .page-section { display: none; }
        .page-section.active { display: block; }
        .header { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 12px 30px; 
            box-shadow: 0 2px 10px var(--shadow); border-bottom: 3px solid var(--green);
        }
        .container { padding: 20px; max-width: 1100px; margin: auto; }
        
        .card { 
            background: var(--white); padding: 25px; border-radius: 12px; 
            border: 1px solid var(--border); margin-bottom: 25px; 
            box-shadow: 0 4px 6px var(--shadow); text-align: left; 
        }
        .section-title { 
            font-size: 0.9em; font-weight: 800; color: var(--blue); 
            border-left: 4px solid var(--orange); padding-left: 10px;
            margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px;
        }

        input, select { 
            padding: 10px; border: 1px solid #ced4da; border-radius: 6px;
            transition: border-color 0.2s; font-size: 0.95em;
        }
        input:focus { border-color: var(--blue); outline: none; box-shadow: 0 0 0 3px rgba(0,86,179,0.1); }
        .full-w { width: 100%; box-sizing: border-box; }

        .tabs-nav { display: flex; gap: 5px; margin-bottom: -1px; overflow-x: auto; }
        .tab-btn { 
            padding: 12px 25px; background: #e2e8f0; border: 1px solid var(--border); 
            border-bottom: none; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; color: #64748b;
            flex-shrink: 0;
        }
        .tab-btn.active { background: var(--white); color: var(--blue); border-top: 3px solid var(--blue); padding-bottom: 13px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .counters-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px; 
            background: #f1f4f8; padding: 20px; border-radius: 10px; margin-bottom: 20px;
        }
        .counter-col { display: flex; flex-direction: column; gap: 10px; }
        .input-group { 
            display: flex; justify-content: space-between; align-items: center; 
            background: var(--white); padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0;
        }
        .input-group label { font-size: 0.85em; font-weight: 600; color: #64748b; }
        .input-group input { width: 100px; border: none; text-align: right; font-weight: bold; color: var(--blue); font-size: 1.1em; }

        .table-container { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { background: #f8f9fa; color: #475569; padding: 12px; font-size: 0.8em; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: top; }
        
        .btn { 
            padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; 
            font-weight: bold; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center;
        }
        .btn-blue { background: var(--blue); color: white; }
        .btn-green { background: var(--green); color: white; }
        .btn-add { background: #e2e8f0; color: var(--dark); margin-top: 10px; font-size: 0.85em; }
        .btn-del { background: #fee2e2; color: var(--red); padding: 5px 10px; font-size: 0.8em; border-radius: 4px; border: none; cursor: pointer;}

        .pos-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .pos-input { width: 50px !important; padding: 5px !important; font-size: 0.8em !important; text-align: center; border: 1px solid var(--orange) !important; }

        #login-page { height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--dark); }
        .login-card { background: white; padding: 40px; border-radius: 20px; width: 340px; box-shadow: 0 20px 40px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div id="login-page" class="page-section active">
        <div class="login-card">
            <h2 style="margin-bottom:25px"><span style="color:var(--orange)">TRADE</span><span style="color:var(--green)">BE</span></h2>
            <div style="text-align:left; margin-bottom:8px; font-size:0.8em; color:gray; font-weight:bold;">ACCESO DE PERSONAL</div>
            <input type="text" id="u" placeholder="Usuario" class="full-w" style="margin-bottom:12px">
            <input type="password" id="p" placeholder="Contrase√±a" class="full-w" style="margin-bottom:25px">
            <button class="btn btn-blue full-w" id="btnLogin" onclick="login()">ENTRAR AL SISTEMA</button>
            <div id="load-msg" style="color:var(--orange); font-size:0.85em; margin-top:15px; display:none; font-weight:bold;">‚åõ CONECTANDO...</div>
        </div>
    </div>

    <div id="app" class="page-section">
        <div class="header">
            <div><span style="color:var(--orange); font-weight:900;">TRADE</span><span style="color:var(--green); font-weight:900;">BE</span> <small style="color:#999; margin-left:10px;">| MOLINO v9.2</small></div>
            <div id="user-tag" style="font-size:0.85em; font-weight:bold; background:#edf2f7; padding:5px 12px; border-radius:20px;"></div>
            <button onclick="logout()" style="background:none; border:1px solid #e2e8f0; padding:6px 12px; cursor:pointer; border-radius:6px; font-size:0.8em; font-weight:bold; color:#666;">Cerrar Sesi√≥n</button>
        </div>
        <div class="container" id="view"></div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxqgA6nGHqUPNz58OXTCxB_rxNh-B84sZsC9bVwJukpEiHcZLqz4oXfXpi7s1Q1Gygh/exec"; // Aseg√∫rate de que esta URL corresponde al Script que tiene las funciones de Admin y Reportes
        let activos = [], tareas = [], recambios = [], excelCreds = {}, reporteActual = [];

        async function login() {
            const user = document.getElementById('u').value.toLowerCase().trim();
            const pass = document.getElementById('p').value;
            if(!user || !pass) return;
            document.getElementById('btnLogin').disabled = true;
            document.getElementById('load-msg').style.display = "block";
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                activos = data.activos; tareas = data.tareas; recambios = data.recambios || []; excelCreds = data.credenciales;
                if ((user === 'admin' && pass === '1234') || (excelCreds[user] && excelCreds[user].toString() === pass)) {
                    document.getElementById('login-page').classList.remove('active');
                    document.getElementById('app').classList.add('active');
                    if (user === 'admin') renderAdmin(); else renderOperario(user);
                } else { alert("Credenciales incorrectas"); document.getElementById('btnLogin').disabled = false; }
            } catch (e) { alert("Error de red"); document.getElementById('btnLogin').disabled = false; }
        }

        function logout() {
            location.reload();
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function renderOperario(name) {
            const todayISO = new Date().toISOString().split('T')[0];
            document.getElementById('user-tag').innerText = "üë§ " + name.toUpperCase();
            document.getElementById('view').innerHTML = `
                <div class="card" style="padding:15px 25px; margin-bottom:15px;">
                    <div style="display:flex; gap:20px; align-items:center; flex-wrap:wrap;">
                        <div style="flex:1; min-width:120px;">
                            <label style="font-size:0.75em; font-weight:bold; color:#64748b;">TURNO</label><br>
                            <select id="f_turno" class="full-w" onchange="resetHoras()"><option>Ma√±ana</option><option>Tarde</option></select>
                        </div>
                        <div style="flex:1; min-width:120px;">
                            <label style="font-size:0.75em; font-weight:bold; color:#64748b;">FECHA DE REGISTRO</label><br>
                            <input type="date" id="f_fecha" class="full-w" value="${todayISO}">
                        </div>
                    </div>
                </div>

                <div class="tabs-nav">
                    <button class="tab-btn active" onclick="switchTab('tab-parte')">PARTE DE TRABAJO</button>
                    <button class="tab-btn" onclick="switchTab('tab-incidencias')">INCIDENCIAS</button>
                    <button class="tab-btn" onclick="switchTab('tab-recambios-div')">RECAMBIOS</button>
                </div>

                <div id="tab-parte" class="tab-content active card">
                    <div class="section-title">Lectura de Contadores</div>
                    <div style="margin-bottom: 20px;"><input type="text" id="f_lote" class="full-w" placeholder="N¬∫ LOTE / ORDEN"></div>
                    <div class="counters-grid">
                        <div class="counter-col">
                            <div class="input-group"><label>H. Molino I</label><input type="number" step="0.01" id="hmi"></div>
                            <div class="input-group"><label>H. Prod I</label><input type="number" step="0.01" id="hpi"></div>
                            <div class="input-group"><label>Z1 (kg) I</label><input type="number" step="0.001" id="z1i"></div>
                            <div class="input-group"><label>Z2 (un.) I</label><input type="number" id="z2i"></div>
                        </div>
                        <div class="counter-col">
                            <div class="input-group"><label>H. Molino F</label><input type="number" step="0.01" id="hmf"></div>
                            <div class="input-group"><label>H. Prod F</label><input type="number" step="0.01" id="hpf"></div>
                            <div class="input-group"><label>Z1 (kg) F</label><input type="number" step="0.001" id="z1f"></div>
                            <div class="input-group"><label>Z2 (un.) F</label><input type="number" id="z2f"></div>
                        </div>
                    </div>
                    <button id="btnSendParte" class="btn btn-blue full-w" onclick="enviar('parte')">ENVIAR LECTURAS</button>
                </div>

                <div id="tab-incidencias" class="tab-content card">
                    <div class="section-title">Registro de Tareas</div>
                    <table id="t-tareas">
                        <thead><tr><th>Parada</th><th>Arranque</th><th>Tarea</th><th>Activo</th><th>Obs</th><th></th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button onclick="addFila()" class="btn btn-add">+ L√≠nea</button>
                    <button id="btnSendInc" class="btn btn-blue full-w" style="margin-top:20px; background:var(--orange)" onclick="enviar('incidencias')">ENVIAR TAREAS</button>
                </div>

                <div id="tab-recambios-div" class="tab-content card">
                    <div class="section-title">Consumo de Materiales</div>
                    <table id="t-recambios">
                        <thead><tr><th width="50%">Recambio</th><th width="40%">Cant. / Posiciones</th><th width="10%"></th></tr></thead>
                        <tbody></tbody>
                    </table>
                    <button onclick="addRecambio()" class="btn btn-add">+ A√±adir Recambio</button>
                    <button id="btnSendRec" class="btn btn-green full-w" style="margin-top:20px;" onclick="enviar('recambios')">REGISTRAR RECAMBIOS</button>
                </div>`;
            addFila(); addRecambio();
        }

        function addFila() {
            const h = genH();
            const r = document.querySelector('#t-tareas tbody').insertRow();
            r.innerHTML = `
                <td><select class="p full-w">${h}</select></td>
                <td><select class="a full-w">${h}</select></td>
                <td><select class="full-w">${tareas.map(t=>`<option>${t}</option>`).join('')}</select></td>
                <td><select class="full-w">${activos.map(a=>`<option>${a}</option>`).join('')}</select></td>
                <td><input type="text" class="obs full-w"></td>
                <td><button class="btn-del" onclick="this.parentElement.parentElement.remove()">‚úï</button></td>`;
        }

        function addRecambio() {
            const r = document.querySelector('#t-recambios tbody').insertRow();
            r.innerHTML = `
                <td><select class="r-item full-w" onchange="handleRecambioChange(this)"><option value="">-- Seleccionar --</option>${recambios.map(item=>`<option>${item}</option>`).join('')}</select></td>
                <td>
                    <input type="number" class="r-cant full-w" placeholder="Cant" oninput="handleCantChange(this)">
                    <div class="pos-container"></div>
                </td>
                <td><button class="btn-del" onclick="this.parentElement.parentElement.remove()">‚úï</button></td>`;
        }

        function handleRecambioChange(sel) {
            const cantInput = sel.parentElement.nextElementSibling.querySelector('.r-cant');
            handleCantChange(cantInput);
        }

        function handleCantChange(input) {
            const row = input.closest('tr');
            const item = row.querySelector('.r-item').value.toLowerCase();
            const container = row.querySelector('.pos-container');
            const cant = parseInt(input.value) || 0;
            container.innerHTML = "";
            
            if ((item.includes("placa") || item.includes("martillo")) && cant > 0) {
                for (let i = 0; i < cant; i++) {
                    const inp = document.createElement('input');
                    inp.type = "number";
                    inp.className = "pos-input";
                    inp.placeholder = "Pos";
                    container.appendChild(inp);
                }
            }
        }

        function genH() {
            const t = document.getElementById('f_turno').value;
            let i = (t === "Ma√±ana") ? 6 : 14, f = (t === "Ma√±ana") ? 14 : 22, html = '<option value="">--:--</option>';
            for (let h = i; h <= f; h++) {
                for (let m = 0; m < 60; m += 5) {
                    if(h === f && m > 0) break;
                    let hh = h.toString().padStart(2,'0') + ":" + m.toString().padStart(2,'0');
                    html += `<option value="${hh}">${hh}</option>`;
                }
            }
            return html;
        }

        function resetHoras() { 
            document.querySelectorAll('#t-tareas select.p, #t-tareas select.a').forEach(s => s.innerHTML = genH()); 
        }

        async function enviar(tipo) {
            const btn = event.target;
            const originalText = btn.innerText;
            const rawFecha = document.getElementById('f_fecha').value;
            const [y, m, d] = rawFecha.split('-');
            const fechaFormateada = `${d}/${m}/${y}`;

            let data = {
                fecha: fechaFormateada,
                turno: document.getElementById('f_turno').value,
                operario: document.getElementById('user-tag').innerText.replace("üë§ ",""),
                tipo: tipo,
                lote: document.getElementById('f_lote')?.value || "N/A"
            };

            if (tipo === 'parte') {
                data.h_mol_ini = document.getElementById('hmi').value;
                data.h_prod_ini = document.getElementById('hpi').value;
                data.z1_ini = document.getElementById('z1i').value;
                data.z2_ini = document.getElementById('z2i').value;
                data.h_mol_fin = document.getElementById('hmf').value;
                data.h_prod_fin = document.getElementById('hpf').value;
                data.z1_fin = document.getElementById('z1f').value;
                data.z2_fin = document.getElementById('z2f').value;
            } else if (tipo === 'incidencias') {
                data.tareas = Array.from(document.querySelectorAll('#t-tareas tbody tr')).map(tr => ({
                    p: tr.querySelector('.p').value, a: tr.querySelector('.a').value,
                    t: tr.cells[2].querySelector('select').value, ac: tr.cells[3].querySelector('select').value,
                    o: tr.querySelector('.obs').value
                })).filter(t => t.p !== "");
            } else if (tipo === 'recambios') {
                data.recambios = Array.from(document.querySelectorAll('#t-recambios tbody tr')).map(tr => {
                    const posInputs = tr.querySelectorAll('.pos-input');
                    const posiciones = Array.from(posInputs).map(i => i.value).filter(v => v !== "");
                    return {
                        item: tr.querySelector('.r-item').value,
                        cant: tr.querySelector('.r-cant').value,
                        posiciones: posiciones
                    };
                }).filter(r => r.item !== "");
            }

            if(!confirm("¬øEnviar datos?")) return;
            btn.disabled = true; btn.innerText = "ENVIANDO...";
            
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
                alert("‚úÖ √âxito");
                if (tipo === 'recambios') {
                    const tbody = document.querySelector('#t-recambios tbody');
                    tbody.innerHTML = "";
                    addRecambio();
                }
            } catch (e) { 
                alert("Error"); 
            } finally {
                btn.disabled = false; 
                btn.innerText = originalText; 
            }
        }

        // --- SECCI√ìN ADMIN (C√≥digo importado de v8.6) ---

        function renderAdmin() {
            document.getElementById('user-tag').innerText = "‚öôÔ∏è ADMINISTRADOR";
            document.getElementById('view').innerHTML = `
                <div class="card">
                    <div class="section-title">Gesti√≥n de Maestros</div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr 1.2fr; gap:15px">
                        <div>
                            <label style="font-size:0.8em; font-weight:bold; color:#64748b;">NUEVA TAREA</label><br>
                            <input type="text" id="nT" class="full-w" style="margin-bottom:5px">
                            <button class="btn btn-blue full-w" style="padding:8px" onclick="addExt('addTarea', 'nT')">A√±adir Tarea</button>
                        </div>
                        <div>
                            <label style="font-size:0.8em; font-weight:bold; color:#64748b;">NUEVO ACTIVO</label><br>
                            <input type="text" id="nA" class="full-w" style="margin-bottom:5px">
                            <button class="btn btn-blue full-w" style="padding:8px" onclick="addExt('addActivo', 'nA')">A√±adir Activo</button>
                        </div>
                        <div>
                            <label style="font-size:0.8em; font-weight:bold; color:#64748b;">NUEVO OPERARIO</label><br>
                            <div style="display:flex; gap:5px; margin-bottom:5px">
                                <input type="text" id="nOp" placeholder="Usuario" class="full-w">
                                <input type="text" id="pOp" placeholder="Pass" class="full-w">
                            </div>
                            <button class="btn btn-green full-w" style="padding:8px" onclick="addOperario()">Crear Operario</button>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="section-title">Hist√≥rico de Datos</div>
                    <div style="display:flex; gap:10px; margin-bottom:20px; align-items:flex-end; flex-wrap:wrap;">
                        <div><label style="font-size:0.7em; font-weight:bold">DESDE</label><br><input type="date" id="f_ini"></div>
                        <div><label style="font-size:0.7em; font-weight:bold">HASTA</label><br><input type="date" id="f_fin"></div>
                        <button class="btn btn-blue" onclick="generarReporte()">CONSULTAR</button>
                        <button id="btnDownload" class="btn btn-green" style="display:none" onclick="descargarCSV()">DESCARGAR EXCEL</button>
                    </div>
                    <div id="report-output" style="max-height:400px; overflow-y:auto; border:1px solid #eee; font-size:0.85em;"></div>
                </div>`;
        }

        async function addExt(acc, inp) {
            const val = document.getElementById(inp).value;
            if(!val) return;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: acc, valor: val }) });
            alert("Grabado correctamente."); document.getElementById(inp).value = "";
        }

        async function addOperario() {
            const nombre = document.getElementById('nOp').value.toLowerCase().trim();
            const pass = document.getElementById('pOp').value;
            if(!nombre || !pass) return;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ accion: 'addOperario', nombre, pass }) });
            alert("Operario creado."); document.getElementById('nOp').value = ""; document.getElementById('pOp').value = "";
        }

        async function generarReporte() {
            const out = document.getElementById('report-output');
            const finiStr = document.getElementById('f_ini').value;
            const ffinStr = document.getElementById('f_fin').value;
            if (!finiStr || !ffinStr) return;
            const fini = new Date(finiStr); fini.setHours(0,0,0,0);
            const ffin = new Date(ffinStr); ffin.setHours(23,59,59,999);
            out.innerHTML = "<div style='padding:20px; text-align:center; color:gray'>Consultando base de datos...</div>";
            document.getElementById('btnDownload').style.display = "none";
            try {
                const res = await fetch(SCRIPT_URL + "?action=getReport");
                const dataRows = await res.json();
                reporteActual = [];
                let html = `<table style="font-size:0.9em"><thead><tr><th>Fecha</th><th>Turno</th><th>Operario</th><th>Tarea</th><th>Activo</th><th>Parada</th><th>Arranque</th></tr></thead><tbody>`;
                dataRows.forEach(row => {
                    // Asumimos formato dd/mm/yyyy en row[0]
                    const p = row[0].split("/");
                    // Crear fecha segura (mes - 1 en JS)
                    const d = new Date(p[2], p[1]-1, p[0]);
                    
                    if (d >= fini && d <= ffin) {
                        // Ajusta los √≠ndices (row[X]) si tu Excel tiene columnas distintas
                        html += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[14]}</td><td>${row[15]}</td><td>${row[12]}</td><td>${row[13]}</td></tr>`;
                        reporteActual.push(row);
                    }
                });
                if(reporteActual.length > 0) {
                    out.innerHTML = html + "</tbody></table>";
                    document.getElementById('btnDownload').style.display = "inline-block";
                } else { out.innerHTML = "<div style='padding:20px; text-align:center'>Sin resultados en este rango.</div>"; }
            } catch (e) { out.innerHTML = "Error de red o formato de fecha."; }
        }

        function descargarCSV() {
            let csv = "sep=,\nFecha,Turno,Operario,Lote,H_Mol_I,H_Prod_I,Z1_I,Z2_I,H_Mol_F,H_Prod_F,Z1_F,Z2_F,Parada,Arranque,Tarea,Activo,Obs\n";
            reporteActual.forEach(row => { 
                // Escapar comillas dobles para CSV v√°lido
                csv += row.map(c => `"${String(c).replace(/"/g, '""')}"`).join(",") + "\n"; 
            });
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Reporte_Tradebe_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }
    </script>
</body>
</html
